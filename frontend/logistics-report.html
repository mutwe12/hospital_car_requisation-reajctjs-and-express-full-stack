<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Logistics Reports | Car Requisitions</title>
<style>
body { font-family:'Times New Roman', Times, serif; background:#f5f5f5; margin:0; padding:0; }
.navbar {
  background:#004aad; color:white; display:flex; justify-content:space-between; align-items:center;
  padding:10px 30px; position:sticky; top:0; z-index:1000;
}
.navbar h1 { margin:0; font-size:22px; }
.navbar ul { list-style:none; display:flex; gap:20px; margin:0; padding:0; }
.navbar a { color:white; text-decoration:none; font-weight:bold; transition:0.3s; }
.navbar a:hover, .navbar a.active { text-decoration:underline; }
.container { max-width:1200px; margin:30px auto; background:#fff; padding:30px; box-shadow:0 0 10px rgba(0,0,0,0.1); border-radius:5px; }
h2 { text-align:center; margin-bottom:20px; color:#004aad; }
.filter-container { text-align:right; margin-bottom:15px; }
.filter-container select { padding:5px 10px; border-radius:4px; }
table { width:100%; border-collapse:collapse; margin-top:10px; }
th,td { border:1px solid #ccc; padding:10px; text-align:center; }
th { background-color:#2c5f2d; color:white; }
tr:nth-child(even){background:#f2f2f2;}
.status-pending { background:#fff3cd; }
.status-approved { background:#d4edda; }
.status-rejected { background:#f8d7da; }
button { padding:6px 12px; margin:5px; border:none; cursor:pointer; border-radius:3px; font-weight:bold; }
.export-btn { background:#28a745; color:white; } .export-btn:hover { background:#218838; }
</style>
</head>
<body>

<!-- Navbar -->
<nav class="navbar">
  <h1>ðŸš— Logistics Dashboard</h1>
  <ul>
    <li><a href="logistics-dashboard.html">Pending Requests</a></li>
    <li><a href="logistics-status.html">My Approvals Status</a></li>
    <li><a href="logistics-report.html" class="active">Reports</a></li>
    <li><a href="#" onclick="logout()">Logout</a></li>
  </ul>
</nav>

<div class="container">
<h2>Logistics Reports</h2>
<div class="filter-container">
  Filter by Status: 
  <select id="statusFilter" onchange="loadReports()">
    <option value="all">All</option>
    <option value="pending">Pending</option>
    <option value="approved">Approved</option>
    <option value="rejected">Rejected</option>
  </select>
  <button class="export-btn" onclick="exportCSV()">Export CSV</button>
</div>

<table id="reportTable">
  <thead>
    <tr>
      <th>ID</th>
      <th>Requester</th>
      <th>Department</th>
      <th>Destination</th>
      <th>Vehicle Type</th>
      <th>Vehicle Plate</th>
      <th>Driver Name</th>
      <th>Status</th>
      <th>Remarks</th>
      <th>Created At</th>
    </tr>
  </thead>
  <tbody></tbody>
</table>
</div>

<script>
const API_URL = "http://localhost:5000/api/requisition/report";
const token = localStorage.getItem("token");

function logout() {
  localStorage.clear();
  window.location.href = "index.html";
}

let reportsData = [];

async function loadReports() {
  try {
    const res = await fetch(API_URL, { headers:{ "Authorization":"Bearer "+token } });
    if (!res.ok) throw new Error(await res.text());
    reportsData = await res.json();

    const filter = document.getElementById("statusFilter").value;
    const tbody = document.querySelector("#reportTable tbody");
    tbody.innerHTML = "";

    let filteredData = reportsData;
    if(filter !== "all") {
      filteredData = reportsData.filter(r => {
        if(filter==="approved") return r.status==="approved" || r.status==="logistics_approved";
        if(filter==="rejected") return r.status==="rejected";
        if(filter==="pending") return r.status==="pending";
      });
    }

    if(!filteredData.length) {
      tbody.innerHTML = `<tr><td colspan="10">No records found</td></tr>`;
      return;
    }

    filteredData.forEach(req => {
      let statusClass = "status-pending";
      if(req.status==="approved" || req.status==="logistics_approved") statusClass="status-approved";
      else if(req.status==="rejected") statusClass="status-rejected";

      const tr = document.createElement("tr");
      tr.className = statusClass;
      tr.innerHTML = `
        <td>${req.id}</td>
        <td>${req.requestedBy}</td>
        <td>${req.department}</td>
        <td>${req.destination}</td>
        <td>${req.vehicleType}</td>
        <td>${req.vehiclePlate || '-'}</td>
        <td>${req.driverName || '-'}</td>
        <td>${req.status}</td>
        <td>${req.remarks || '-'}</td>
        <td>${req.created_at || '-'}</td>
      `;
      tbody.appendChild(tr);
    });

  } catch(err) {
    console.error("Failed to load reports:", err);
    alert("Failed to load reports. See console for details.");
  }
}

// Export table to CSV
function exportCSV() {
  if(!reportsData.length) return alert("No data to export");
  let csv = "ID,Requester,Department,Destination,VehicleType,VehiclePlate,DriverName,Status,Remarks,CreatedAt\n";
  reportsData.forEach(r=>{
    csv += `"${r.id}","${r.requestedBy}","${r.department}","${r.destination}","${r.vehicleType}","${r.vehiclePlate||''}","${r.driverName||''}","${r.status}","${r.remarks||''}","${r.created_at||''}"\n`;
  });
  const blob = new Blob([csv], {type:'text/csv'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url;
  a.download = "logistics_report.csv";
  a.click();
  URL.revokeObjectURL(url);
}

// Initial load
loadReports();
</script>
</body>
</html>
