<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Admin Panel - Manage Users</title>
<style>
/* Body & Navbar */
body {
  font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
  background-color: #f7f9fc;
  margin: 0; padding: 0;
}
.navbar {
  background: #004aad; color: #fff;
  display: flex; justify-content: space-between; align-items: center;
  padding: 10px 30px;
}
.navbar h1 { margin: 0; font-size: 22px; }
.navbar ul { list-style: none; display: flex; gap: 20px; margin: 0; padding: 0; }
.navbar a { color: #fff; text-decoration: none; font-weight: bold; }
.navbar a:hover, .navbar a.active { text-decoration: underline; }

/* Container & Header */
.container { width: 95%; margin: 20px auto; }
h2 { color: #004aad; margin-top: 20px; text-align: center; }

/* Cards */
.cards-container {
  display: flex; flex-wrap: wrap; gap: 15px; margin-bottom: 20px;
}
.card {
  flex: 1; min-width: 150px;
  background:#fff; padding:15px; border-radius:8px;
  box-shadow:0 2px 8px rgba(0,0,0,0.1); text-align:center;
}
.card div:first-child { font-weight: bold; color:#004aad; }
.card div:last-child { font-size: 24px; font-weight:bold; margin-top:5px; }

/* Table */
table {
  width: 100%; border-collapse: collapse;
  background: #fff; box-shadow: 0 2px 10px rgba(0,0,0,0.1);
  margin-bottom: 30px;
}
th, td { padding: 10px; border: 1px solid #ddd; text-align: center; }
th { background-color: #004aad; color: white; }
td { background-color: #fefefe; }

/* Buttons */
button { padding: 5px 10px; border: none; border-radius: 4px; cursor: pointer; }
.add-btn { background-color: #004aad; color: white; margin:2px; }
.edit-btn { background-color: #28a745; color: white; margin:2px; }
.delete-btn { background-color: #dc3545; color: white; margin:2px; }

/* Modal */
.modal {
  display: none; position: fixed; z-index: 1000;
  left: 0; top: 0; width: 100%; height: 100%;
  overflow: auto; background-color: rgba(0,0,0,0.5);
}
.modal-content {
  background-color: #fff; margin: 10% auto; padding: 20px;
  border-radius: 8px; width: 350px; position: relative;
}
.close {
  color: #aaa; position: absolute; top: 10px; right: 15px;
  font-size: 28px; font-weight: bold; cursor: pointer;
}
.close:hover { color: black; }

/* Form */
.modal-content input, .modal-content select {
  width: 100%; padding: 10px; margin-bottom: 15px;
  border: 1px solid #ccc; border-radius: 4px;
}
.modal-content button {
  width: 100%; padding: 10px; border: none; border-radius: 4px;
  background-color: #004aad; color: white; font-weight: bold; cursor: pointer;
}
.modal-content button:hover { background-color: #003080; }

/* Responsive */
@media(max-width:900px){ .cards-container { flex-direction: column; } table { display:block; overflow-x:auto; } }

</style>
</head>
<body>

<nav class="navbar">
  <h1>ðŸš— Car Requisition Admin Panel</h1>
  <ul>
    <li><a href="dashboard.html">Dashboard</a></li>
    <li><a href="#" class="active">Manage Users</a></li>
    <li><a href="reports.html">Reports</a></li>
    <li><a href="#" onclick="logout()">Logout</a></li>
  </ul>
</nav>

<div class="container">
  <h2>Welcome, <span id="userName">Admin</span>!</h2>

  <!-- Quick Stats Cards -->
  <div class="cards-container">
    <div class="card"><div>Total Users</div><div id="totalUsers">0</div></div>
    <div class="card"><div>Departments</div><div id="deptUsers">0</div></div>
    <div class="card"><div>Requesters</div><div id="requesters">0</div></div>
    <div class="card"><div>Logistics</div><div id="logistics">0</div></div>
  </div>

  <!-- Add User Button -->
  <button class="add-btn" onclick="openModal()">âž• Add New User</button>

  <!-- Users Table -->
  <table>
    <thead>
      <tr>
        <th>ID</th>
        <th>Username</th>
        <th>Role</th>
        <th>Created At</th>
        <th>Actions</th>
      </tr>
    </thead>
    <tbody id="usersTableBody">
      <tr><td colspan="5" style="text-align:center;">Loading users...</td></tr>
    </tbody>
  </table>
</div>

<!-- Modal -->
<div id="userModal" class="modal">
  <div class="modal-content">
    <span class="close" onclick="closeModal()">&times;</span>
    <h3 id="modalTitle">Add New User</h3>
    <input type="hidden" id="userId">
    <label>Username</label>
    <input type="text" id="modalUsername" placeholder="Enter username">
    <label>Password</label>
    <input type="password" id="modalPassword" placeholder="Enter password">
    <label>Role</label>
    <select id="modalRole">
      <option value="">Select role</option>
      <option value="requester">Requester</option>
      <option value="department">Department</option>
      <option value="logistics">Logistics</option>
      <option value="daf">DAF</option>
      <option value="admin">Admin</option>
    </select>
    <button onclick="saveUser()">Save User</button>
  </div>
</div>

<script>
const token = localStorage.getItem("token");
const username = localStorage.getItem("username");
document.getElementById("userName").textContent = username;

async function fetchUsers() {
  const tbody = document.getElementById("usersTableBody");
  try {
    const res = await fetch("/api/users", { headers:{ "Authorization":"Bearer "+token }});
    const data = await res.json();

    tbody.innerHTML = "";
    if(!data.length) { tbody.innerHTML='<tr><td colspan="5">No users found</td></tr>'; return; }

    document.getElementById("totalUsers").textContent = data.length;
    document.getElementById("deptUsers").textContent = data.filter(u=>u.role==='department').length;
    document.getElementById("requesters").textContent = data.filter(u=>u.role==='requester').length;
    document.getElementById("logistics").textContent = data.filter(u=>u.role==='logistics').length;

    data.forEach(u=>{
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td>${u.id}</td>
        <td>${u.username}</td>
        <td>${u.role}</td>
        <td>${new Date(u.created_at).toLocaleString()}</td>
        <td>
          <button class="edit-btn" onclick="editUser(${u.id},'${u.username}','${u.role}')">Edit</button>
          <button class="delete-btn" onclick="deleteUser(${u.id})">Delete</button>
        </td>
      `;
      tbody.appendChild(tr);
    });

  } catch(err){ console.error(err); tbody.innerHTML='<tr><td colspan="5">Error loading users</td></tr>'; }
}

// Modal Functions
function openModal() {
  document.getElementById("userModal").style.display = "block";
  document.getElementById("modalTitle").textContent = "Add New User";
  document.getElementById("modalUsername").value = "";
  document.getElementById("modalPassword").value = "";
  document.getElementById("modalRole").value = "";
  document.getElementById("userId").value = "";
}

function closeModal() { document.getElementById("userModal").style.display = "none"; }

function editUser(id, uname, role) {
  document.getElementById("userModal").style.display = "block";
  document.getElementById("modalTitle").textContent = "Edit User";
  document.getElementById("modalUsername").value = uname;
  document.getElementById("modalPassword").value = ""; // optional: leave blank to not change
  document.getElementById("modalRole").value = role;
  document.getElementById("userId").value = id;
}

async function saveUser() {
  const id = document.getElementById("userId").value;
  const uname = document.getElementById("modalUsername").value.trim();
  const pwd = document.getElementById("modalPassword").value.trim();
  const role = document.getElementById("modalRole").value;

  if(!uname || (!id && !pwd) || !role) { alert("Fill all fields"); return; }

  try {
    let res;
    if(id) {
      // Edit user
      res = await fetch(`/api/users/${id}`, {
        method: "PUT",
        headers:{ "Content-Type":"application/json", "Authorization":"Bearer "+token },
        body: JSON.stringify({ username:uname, password: pwd, role })
      });
    } else {
      // Add new user
      res = await fetch(`/api/users`, {
        method: "POST",
        headers:{ "Content-Type":"application/json", "Authorization":"Bearer "+token },
        body: JSON.stringify({ username: uname, password: pwd, role })
      });
    }

    const data = await res.json();
    if(res.ok){ alert(data.message||"Saved successfully"); closeModal(); fetchUsers(); }
    else alert(data.message||"Error saving user");

  } catch(err){ console.error(err); alert("Server error"); }
}

async function deleteUser(id) {
  if(!confirm("Are you sure to delete this user?")) return;
  try {
    const res = await fetch(`/api/users/${id}`, {
      method:"DELETE", headers:{ "Authorization":"Bearer "+token }
    });
    const data = await res.json();
    if(res.ok){ alert(data.message||"User deleted"); fetchUsers(); }
    else alert(data.message||"Error deleting user");
  } catch(err){ console.error(err); alert("Server error"); }
}

// Logout
function logout() { localStorage.clear(); window.location.href="index.html"; }

window.onclick = function(event) {
  if (event.target == document.getElementById("userModal")) closeModal();
}

// Initial load
fetchUsers();
</script>

</body>
</html>
