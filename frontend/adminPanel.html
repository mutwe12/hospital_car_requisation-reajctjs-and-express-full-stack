<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Car Requisition Admin Panel</title>
<link rel="stylesheet" href="navbar.css">
<style>
/* Body & Navbar */
body {
  font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
  background-color: #f7f9fc;
  margin: 0; padding: 0;
}
.navbar {
  background: #004aad; color: #fff;
  display: flex; justify-content: space-between; align-items: center;
  padding: 10px 30px;
}
.navbar h1 { margin: 0; font-size: 22px; }
.navbar ul { list-style: none; display: flex; gap: 20px; margin: 0; padding: 0; }
.navbar a { color: #fff; text-decoration: none; font-weight: bold; }
.navbar a:hover, .navbar a.active { text-decoration: underline; }

/* Container & Header */
.container { width: 95%; margin: 20px auto; }
h2 { color: #004aad; margin-top: 20px; text-align: center; }

/* Cards */
.cards-container {
  display: flex; flex-wrap: wrap; gap: 15px; margin-bottom: 20px;
}
.card {
  flex: 1; min-width: 150px;
  background:#fff; padding:15px; border-radius:8px;
  box-shadow:0 2px 8px rgba(0,0,0,0.1); text-align:center;
}
.card div:first-child { font-weight: bold; color:#004aad; }
.card div:last-child { font-size: 24px; font-weight:bold; margin-top:5px; }

/* Filters */
.filters { display: flex; gap:10px; margin-bottom:15px; flex-wrap:wrap; }
.filters label { font-weight:bold; margin-right:5px; }
.filters select, .filters input { padding:5px; border-radius:4px; border:1px solid #ccc; }

/* Table */
table {
  width: 100%; border-collapse: collapse;
  background: #fff; box-shadow: 0 2px 10px rgba(0,0,0,0.1);
  margin-bottom: 30px;
}
th, td { padding: 10px; border: 1px solid #ddd; text-align: center; }
th { background-color: #004aad; color: white; }
td { background-color: #fefefe; }

/* Buttons */
button { padding: 5px 10px; border: none; border-radius: 4px; cursor: pointer; }
.approve-btn { background-color: #28a745; color: white; margin:2px; }
.reject-btn { background-color: #dc3545; color: white; margin:2px; }

/* Badges */
.badge-approved { background-color: #28a745; color: #fff; padding: 3px 6px; border-radius: 4px; font-size: 0.9em; }
.badge-pending { background-color: #f59e0b; color: #fff; padding: 3px 6px; border-radius: 4px; font-size: 0.9em; }
.badge-rejected { background-color: #dc3545; color: #fff; padding: 3px 6px; border-radius: 4px; font-size: 0.9em; }

/* Responsive */
@media(max-width:900px){ .cards-container { flex-direction: column; } table { display:block; overflow-x:auto; } }
</style>
</head>
<body>

<nav class="navbar">
  <h1>üöó Car Requisition System</h1>
  <ul>
    <li><a href="homepage.html">Home</a></li>
    <li><a href="ManageUser.html">ManageUsers</a></li>

    <li><a href="dashboard.html" class="active">Dashboard</a></li>
    <li><a href="user.html">Request Form</a></li>
    <li><a href="approvals.html">Progress</a></li>
    <li><a href="department_approval.html">Department Approval</a></li>
    <li><a href="logistics.html">Logistics Approval</a></li>
    <li><a href="daf.html">DAF Approval</a></li>
    <li><a href="reports.html">Reports</a></li>
    <li><a href="#" onclick="logout()">Logout</a></li>
  </ul>
</nav>

<div class="container">
  <h2>Welcome, <span id="userName">User</span>!</h2>

  <!-- Quick Stats Cards -->
  <div class="cards-container">
    <div class="card"><div>Total Requests</div><div id="totalRequests">0</div></div>
    <div class="card"><div>Pending Dept</div><div id="pendingDept">0</div></div>
    <div class="card"><div>Pending Logistics</div><div id="pendingLogistics">0</div></div>
    <div class="card"><div>Pending DAF</div><div id="pendingDAF">0</div></div>
  </div>

  <!-- Filters -->
  <div class="filters">
    <label>Department:</label>
    <select id="filterDept"><option value="">All</option></select>
    <label>Status:</label>
    <select id="filterStatus">
      <option value="">All</option>
      <option value="pending">Pending</option>
      <option value="dept_approved">Dept Approved</option>
      <option value="logistics_approved">Logistics Approved</option>
      <option value="approved">Approved</option>
      <option value="rejected">Rejected</option>
    </select>
    <label>Start Date:</label><input type="date" id="filterStart">
    <label>End Date:</label><input type="date" id="filterEnd">
    <button onclick="fetchRequests()">Filter</button>
  </div>

  <!-- Requests Table -->
  <table>
    <thead>
      <tr>
        <th>ID</th>
        <th>Requested By</th>
        <th>Purpose</th>
        <th>Destination</th>
        <th>Vehicle Type</th>
        <th>Department</th>
        <th>Logistics</th>
        <th>DAF</th>
        <th>Status</th>
        <th>Actions</th>
      </tr>
    </thead>
    <tbody id="requestsTableBody">
      <tr><td colspan="10" style="text-align:center;">Loading requests...</td></tr>
    </tbody>
  </table>
</div>

<script>
const token = localStorage.getItem("token");
const username = localStorage.getItem("username");
const role = localStorage.getItem("role");

if (!token) window.location.href = "index.html";
document.getElementById("userName").textContent = username;

async function fetchRequests() {
  const tbody = document.getElementById("requestsTableBody");
  const deptSelect = document.getElementById("filterDept");
  const statusSelect = document.getElementById("filterStatus");
  const startDate = document.getElementById("filterStart").value;
  const endDate = document.getElementById("filterEnd").value;

  try {
    let url = "/api/requisition";
    if (role === "requester") url += "/my";

    const res = await fetch(url, { headers: { "Authorization": "Bearer " + token } });
    let data = await res.json();

    // Apply frontend filters
    if (deptSelect.value) data = data.filter(r => r.department === deptSelect.value);
    if (statusSelect.value) data = data.filter(r => r.status === statusSelect.value);
    if (startDate) data = data.filter(r => new Date(r.created_at) >= new Date(startDate));
    if (endDate) data = data.filter(r => new Date(r.created_at) <= new Date(endDate));

    tbody.innerHTML = "";

    if (!data || data.length === 0) {
      tbody.innerHTML = `<tr><td colspan="10">No requests found</td></tr>`;
      return;
    }

    // Populate department filter dynamically
    const departments = [...new Set(data.map(r => r.department))];
    deptSelect.innerHTML = '<option value="">All</option>' + departments.map(d => `<option value="${d}">${d}</option>`).join('');

    // Stats cards
    document.getElementById("totalRequests").textContent = data.length;
    document.getElementById("pendingDept").textContent = data.filter(r => !r.deptSignature && r.status==='pending').length;
    document.getElementById("pendingLogistics").textContent = data.filter(r => r.deptSignature && !r.logisticsSignature).length;
    document.getElementById("pendingDAF").textContent = data.filter(r => r.logisticsSignature && !r.dafSignature).length;

    // Table rows
    data.forEach(req => {
      const deptStatus = req.deptSignature ? `<span class="badge-approved">‚úÖ ${req.deptSignature}</span>` : `<span class="badge-pending">‚è≥ Pending</span>`;
      const logisticsStatus = req.logisticsSignature ? `<span class="badge-approved">‚úÖ ${req.logisticsSignature}</span>` : (req.deptSignature ? `<span class="badge-pending">‚è≥ Pending</span>` : '‚Äî');
      const dafStatus = req.dafSignature ? `<span class="badge-approved">‚úÖ ${req.dafSignature}</span>` : (req.logisticsSignature ? `<span class="badge-pending">‚è≥ Pending</span>` : '‚Äî');

      // Actions
      let actions = '‚Äî';
      if ((role==='department' && req.status==='pending') ||
          (role==='logistics' && req.status==='dept_approved') ||
          (role==='daf' && req.status==='logistics_approved')) {
        actions = `
          <button class="approve-btn" onclick="approveRequest(${req.id},'${role}')">Approve</button>
          <button class="reject-btn" onclick="rejectRequest(${req.id},'${role}')">Reject</button>
        `;
      }

      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td>${req.id}</td>
        <td>${req.requestedBy}</td>
        <td>${req.purpose}</td>
        <td>${req.destination}</td>
        <td>${req.vehicleType}</td>
        <td>${deptStatus}</td>
        <td>${logisticsStatus}</td>
        <td>${dafStatus}</td>
        <td>${req.status.replace('_',' ').toUpperCase()}</td>
        <td>${actions}</td>
      `;
      tbody.appendChild(tr);
    });

  } catch(err) {
    console.error(err);
    tbody.innerHTML = "<tr><td colspan='10'>Error loading requests</td></tr>";
  }
}

// Approve / Reject
async function approveRequest(id, roleType) {
  try {
    await fetch(`/api/requisition/approve/${roleType}/${id}`, {
      method: "PUT",
      headers: { "Content-Type":"application/json", "Authorization":"Bearer "+token },
      body: JSON.stringify({ [`${roleType}Signature`]: username })
    });
    fetchRequests();
  } catch(err){ console.error(err); }
}

async function rejectRequest(id, roleType) {
  const reason = prompt("Enter rejection reason:");
  if (!reason) return;
  try {
    await fetch(`/api/requisition/reject/${roleType}/${id}`, {
      method: "PUT",
      headers: { "Content-Type":"application/json", "Authorization":"Bearer "+token },
      body: JSON.stringify({ reason })
    });
    fetchRequests();
  } catch(err){ console.error(err); }
}

// Logout
function logout() {
  localStorage.clear();
  window.location.href = "index.html";
}

// Initial load & auto-refresh
fetchRequests();
setInterval(fetchRequests, 10000);
</script>
<!-- Footer -->
<footer style="text-align:center; padding:15px 0; font-size:12px; color:#777;">
    ¬© 2025 Mugonero District Hospital | All rights reserved
</footer>
</body>
</html>
