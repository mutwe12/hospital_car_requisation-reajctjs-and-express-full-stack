<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Department Approval | Car Requisition</title>
<style>
  body {
    font-family:'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    background-color:#f7f9fc;
    margin:0;
    padding:0;
  }

  .navbar {
    background-color:#004aad;
    color:white;
    padding:12px 30px;
    display:flex;
    justify-content:space-between;
    align-items:center;
  }
  .navbar h1 { margin:0; font-size:20px; }
  .navbar button {
    background:#dc3545; color:white; border:none;
    padding:6px 12px; border-radius:4px; cursor:pointer;
  }
  .navbar button:hover { background:#a71d2a; }

  /* Welcome Section */
  .welcome-box {
    background:#e9f1ff;
    border-left:5px solid #004aad;
    max-width:1100px;
    margin:20px auto;
    padding:15px 25px;
    border-radius:6px;
    box-shadow:0 2px 6px rgba(0,0,0,0.05);
    color:#004aad;
    font-size:17px;
    display:flex;
    justify-content:space-between;
    align-items:center;
  }
  .welcome-box span {
    font-weight:bold;
  }

  .container {
    max-width:1100px;
    margin:20px auto;
    background:white;
    padding:20px 30px;
    border-radius:8px;
    box-shadow:0 3px 15px rgba(0,0,0,0.1);
  }
  h2 {
    text-align:center;
    color:#004aad;
    margin-bottom:25px;
  }

  table {
    width:100%;
    border-collapse:collapse;
    box-shadow:0 2px 8px rgba(0,0,0,0.05);
  }
  th, td {
    padding:12px 10px;
    text-align:center;
    border-bottom:1px solid #ddd;
  }
  th {
    background-color:#004aad;
    color:white;
    position: sticky;
    top:0;
  }
  tr:nth-child(even){ background:#f8f9fa; }

  button.approve-btn {
    background:#28a745; color:white; padding:6px 12px; border-radius:4px; border:none; cursor:pointer;
  }
  button.approve-btn:hover { background:#218838; }

  button.reject-btn {
    background:#dc3545; color:white; padding:6px 12px; border-radius:4px; border:none; cursor:pointer;
  }
  button.reject-btn:hover { background:#c82333; }

  .badge-approved { background:#28a745; color:white; padding:4px 8px; border-radius:4px; font-weight:bold; }
  .badge-pending { background:#f59e0b; color:white; padding:4px 8px; border-radius:4px; font-weight:bold; }
  .badge-rejected { background:#dc3545; color:white; padding:4px 8px; border-radius:4px; font-weight:bold; }

  @media(max-width:768px){
    table, thead, tbody, th, td, tr { display:block; }
    th { position:relative; top:auto; background:#004aad; color:white; }
    td { text-align:right; padding-left:50%; position:relative; }
    td::before {
      content:attr(data-label);
      position:absolute;
      left:10px;
      width:45%;
      text-align:left;
      font-weight:bold;
    }
  }
</style>
</head>
<body>

<nav class="navbar">
  <h1>üöó Car Requisition System - Department</h1>
  <button onclick="logout()">Logout</button>
</nav>

<div class="welcome-box">
  <div id="welcomeMessage">Welcome, <span id="deptName">Department User</span> üëã</div>
  <div id="dateToday"></div>
</div>

<div class="container">
  <h2>Pending Car Requisitions</h2>
  <table>
    <thead>
      <tr>
        <th>ID</th>
        <th>Requester</th>
        <th>Department</th>
        <th>Destination</th>
        <th>Vehicle Type</th>
        <th>Status</th>
        <th>Action</th>
      </tr>
    </thead>
    <tbody id="requisitionBody">
      <tr><td colspan="7">Loading...</td></tr>
    </tbody>
  </table>
</div>

<script>
const API_URL = "/api/requisition";
const token = localStorage.getItem("token");
const role = localStorage.getItem("role");
const deptName = localStorage.getItem("departmentName") || "Department";

if(role !== "department" && role !== "admin"){
  alert("Access denied");
  window.location.href="index.html";
}

// Display welcome message
document.getElementById("deptName").textContent = deptName;
document.getElementById("dateToday").textContent = new Date().toLocaleDateString();

async function loadRequisitions() {
  try {
    const res = await fetch(API_URL, { headers:{ "Authorization": token ? `Bearer ${token}` : "" } });
    const data = await res.json();
    const tbody = document.getElementById("requisitionBody");
    tbody.innerHTML = "";

    const pending = data.filter(r => r.status === "pending" && !r.deptSignature);

    if(!pending.length){
      tbody.innerHTML = '<tr><td colspan="7">No pending requisitions</td></tr>';
      return;
    }

    pending.forEach(req=>{
      let status = "‚è≥ Pending";
      let badgeClass = "badge-pending";
      if(req.deptSignature){ status="‚úÖ Approved"; badgeClass="badge-approved"; }
      else if(req.deptRejected){ status="‚ùå Rejected"; badgeClass="badge-rejected"; }

      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td data-label="ID">${req.id}</td>
        <td data-label="Requester">${req.requestedBy}</td>
        <td data-label="Department">${req.department}</td>
        <td data-label="Destination">${req.destination}</td>
        <td data-label="Vehicle">${req.vehicleType}</td>
        <td data-label="Status"><span class="${badgeClass}">${status}</span></td>
        <td data-label="Action">
          <button class="approve-btn" onclick="approveDept(${req.id})">Approve</button>
          <button class="reject-btn" onclick="rejectDept(${req.id})">Reject</button>
        </td>
      `;
      tbody.appendChild(tr);
    });
  } catch(err){
    console.error(err);
    alert("Error loading requisitions");
  }
}

async function approveDept(id){
  try{
    const res = await fetch(`${API_URL}/approve/department/${id}`, {
      method:"PUT",
      headers:{ "Content-Type":"application/json", "Authorization": `Bearer ${token}` },
      body: JSON.stringify({ deptSignature:"Approved" })
    });
    const data = await res.json();
    alert(data.message);
    loadRequisitions();
  }catch(err){ console.error(err); alert("Error approving"); }
}

async function rejectDept(id){
  const reason = prompt("Enter rejection reason:");
  if(!reason) return;
  try{
    const res = await fetch(`${API_URL}/reject/department/${id}`, {
      method:"PUT",
      headers:{ "Content-Type":"application/json", "Authorization": `Bearer ${token}` },
      body: JSON.stringify({ reason })
    });
    const data = await res.json();
    alert(data.message);
    loadRequisitions();
  }catch(err){ console.error(err); alert("Error rejecting"); }
}

function logout(){ localStorage.clear(); window.location.href="index.html"; }

loadRequisitions();
</script>

</body>
</html>
