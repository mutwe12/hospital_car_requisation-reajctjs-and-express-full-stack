<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>User Dashboard | Car Requisition</title>
<style>
body {
  font-family:"Segoe UI",Tahoma,Geneva,Verdana,sans-serif;
  margin:0; padding:0; background:#f7f9fc;
}
/* Navbar */
.navbar {
  background:#004aad; color:#fff;
  display:flex; justify-content:space-between; align-items:center;
  padding:10px 30px;
}
.navbar h1{ margin:0; font-size:22px; }
.navbar ul{ list-style:none; display:flex; gap:20px; margin:0; padding:0; }
.navbar a{ color:#fff; text-decoration:none; font-weight:bold; transition:0.3s; }
.navbar a:hover, .navbar a.active{ text-decoration:underline; }

/* Welcome */
.welcome { text-align:center; font-size:18px; color:#333; margin:15px 0; }

/* Cards */
.cards-container { display:flex; flex-wrap:wrap; gap:15px; justify-content:center; margin:20px 0; }
.card {
  background:#fff; padding:15px 20px; border-radius:8px;
  box-shadow:0 2px 8px rgba(0,0,0,0.1); min-width:140px; text-align:center;
}
.card div:first-child{ font-weight:bold; color:#004aad; }
.card div:last-child{ font-size:24px; font-weight:bold; margin-top:5px; }

/* Form container */
.container { width:90%; max-width:800px; margin:10px auto; background:#fff; padding:20px 25px; box-shadow:0 2px 10px rgba(0,0,0,0.1); border-radius:5px; }
h2{ text-align:center; color:#004aad; margin-top:30px; margin-bottom:15px; }
.form-group{ display:flex; flex-wrap:wrap; margin-bottom:15px; align-items:center; }
.form-group label{ width:180px; font-weight:bold; margin-bottom:5px; }
.form-group input, .form-group select{ flex:1; padding:8px; border:1px solid #ccc; border-radius:4px; font-size:14px; }
.btn{ background:#004aad; color:#fff; border:none; padding:10px 25px; font-size:14px; border-radius:4px; cursor:pointer; margin:10px 5px; }
.btn:hover{ background:#003080; }
button.cancel-btn{ background:#dc3545; padding:5px 12px; font-size:12px; border-radius:3px; cursor:pointer; color:white; border:none; }
button.cancel-btn:hover{ background:#a71d2a; }

/* Table */
table{ width:100%; border-collapse:collapse; margin:20px 0; background:#fff; box-shadow:0 2px 10px rgba(0,0,0,0.1); }
th, td{ padding:10px; border:1px solid #ddd; text-align:center; }
th{ background:#004aad; color:#fff; }
td{ background:#fefefe; }

/* Status badges */
.badge-approved{ background:#28a745; color:#fff; padding:4px 7px; border-radius:4px; font-size:0.9em; }
.badge-pending{ background:#f59e0b; color:#fff; padding:4px 7px; border-radius:4px; font-size:0.9em; }
.badge-rejected{ background:#dc3545; color:#fff; padding:4px 7px; border-radius:4px; font-size:0.9em; }

/* Filters */
.filter-container{ width:100%; margin-bottom:10px; text-align:right; }
.filter-container select{ padding:5px 10px; border-radius:4px; }

/* Responsive */
@media(max-width:900px){ .cards-container{ flex-direction:column; } table{ display:block; overflow-x:auto; } }
</style>
</head>
<body>

<nav class="navbar">
  <h1>üöó Car Requisition System</h1>
  <ul>
    <li><a href="homepage.html">Home</a></li>
    <li><a href="#" class="active">My Dashboard</a></li>
    <li><a href="index.html" onclick="logout()">Logout</a></li>
  </ul>
</nav>

<div class="welcome">Welcome, <span id="username">User</span>!</div>

<!-- Quick Stats -->
<div class="cards-container">
  <div class="card"><div>Total Requests</div><div id="totalRequests">0</div></div>
  <div class="card"><div>Pending</div><div id="pendingRequests">0</div></div>
  <div class="card"><div>Approved</div><div id="approvedRequests">0</div></div>
  <div class="card"><div>Rejected</div><div id="rejectedRequests">0</div></div>
</div>

<h2>Submit a New Requisition</h2>
<div class="container">
  <form id="carRequisitionForm">
    <div class="form-group"><label>Date:</label><input type="date" id="date" required /></div>
    <div class="form-group"><label>Department:</label><input type="text" id="department" required /></div>
    <div class="form-group"><label>Requested by (Name & Title):</label><input type="text" id="requestedBy" required /></div>
    <div class="form-group"><label>Purpose:</label><input type="text" id="purpose" required /></div>
    <div class="form-group"><label>Destination:</label><input type="text" id="destination" required /></div>
    <div class="form-group"><label>Departure:</label><input type="datetime-local" id="departure" required /></div>
    <div class="form-group"><label>Return:</label><input type="datetime-local" id="return" required /></div>
    <div class="form-group"><label>Passengers:</label><input type="text" id="passengers" /></div>
    <div class="form-group"><label>Vehicle Type:</label>
      <select id="vehicleType" required>
        <option value="">Select Vehicle Type</option>
        <option value="Sedan">Sedan</option>
        <option value="SUV">SUV</option>
        <option value="Van">Van</option>
        <option value="Truck">Truck</option>
        <option value="Ambulance">Ambulance</option>
      </select>
    </div>
    <div style="text-align:center;">
      <button type="submit" class="btn">Submit</button>
      <button type="button" class="btn" style="background:#6c757d;" onclick="resetForm()">Clear</button>
    </div>
  </form>
</div>

<h2>My Requisition Progress</h2>
<div class="filter-container">
  Filter: 
  <select id="statusFilter" onchange="loadMyRequests()">
    <option value="all">All</option>
    <option value="pending">Pending</option>
    <option value="approved">Approved</option>
    <option value="rejected">Rejected</option>
  </select>
</div>
<table>
  <thead>
    <tr>
      <th>ID</th>
      <th>Date</th>
      <th>Purpose</th>
      <th>Destination</th>
      <th>Vehicle Type</th>
      <th>Department</th>
      <th>Logistics</th>
      <th>DAF</th>
      <th>Action</th>
    </tr>
  </thead>
  <tbody id="tableBody">
    <tr><td colspan="9" style="text-align:center;">Loading...</td></tr>
  </tbody>
</table>

<script>
const API_URL = "http://localhost:5000/api/requisition";
const token = localStorage.getItem("token");
const username = localStorage.getItem("username");
const role = localStorage.getItem("role");

if(!token){ alert("Not logged in!"); window.location.href="index.html";}
if(role!=="requester"){ alert("Access denied!"); window.location.href="homepage.html";}
document.getElementById("username").textContent=username;
document.getElementById("requestedBy").value=username;
document.getElementById("date").valueAsDate = new Date();

async function loadMyRequests(){
  const tbody = document.getElementById("tableBody");
  const filter = document.getElementById("statusFilter").value;
  try{
    const res = await fetch(`${API_URL}/my`, { headers:{Authorization:"Bearer "+token}});
    const data = await res.json();
    tbody.innerHTML="";
    if(!data.length){ tbody.innerHTML="<tr><td colspan='9' style='text-align:center;'>No requisitions found</td></tr>"; return; }

    // Stats cards
    const total = data.length;
    const pending = data.filter(r=>!r.deptSignature && !r.logisticsSignature && !r.dafSignature).length;
    const approved = data.filter(r=>r.dafSignature).length;
    const rejected = data.filter(r=>r.deptRejected || r.logisticsRejected || r.dafRejected).length;

    document.getElementById("totalRequests").textContent=total;
    document.getElementById("pendingRequests").textContent=pending;
    document.getElementById("approvedRequests").textContent=approved;
    document.getElementById("rejectedRequests").textContent=rejected;

    data.forEach(req=>{
      let statusClass="badge-pending";
      if(req.dafSignature) statusClass="badge-approved";
      else if(req.deptRejected||req.logisticsRejected||req.dafRejected) statusClass="badge-rejected";
      if(filter==="approved" && statusClass!=="badge-approved") return;
      if(filter==="rejected" && statusClass!=="badge-rejected") return;
      if(filter==="pending" && statusClass!=="badge-pending") return;

      const dept=req.deptSignature?"‚úÖ Approved":req.deptRejected?"‚ùå Rejected":"‚è≥ Pending";
      const logistics=req.logisticsSignature?"‚úÖ Approved":req.logisticsRejected?"‚ùå Rejected":req.deptSignature?"‚è≥ Pending":"‚Äî";
      const daf=req.dafSignature?"‚úÖ Approved":req.dafRejected?"‚ùå Rejected":req.logisticsSignature?"‚è≥ Pending":"‚Äî";

      const tr=document.createElement("tr");
      tr.innerHTML=`
        <td>${req.id}</td>
        <td>${req.date||"-"}</td>
        <td>${req.purpose}</td>
        <td>${req.destination}</td>
        <td>${req.vehicleType}</td>
        <td><span class="${req.deptSignature?"badge-approved":req.deptRejected?"badge-rejected":"badge-pending"}">${dept}</span></td>
        <td><span class="${req.logisticsSignature?"badge-approved":req.logisticsRejected?"badge-rejected":"badge-pending"}">${logistics}</span></td>
        <td><span class="${req.dafSignature?"badge-approved":req.dafRejected?"badge-rejected":"badge-pending"}">${daf}</span></td>
        <td>${!req.deptSignature&&!req.logisticsSignature&&!req.dafSignature?`<button class="cancel-btn" onclick="cancelRequest(${req.id})">Cancel</button>`:""}</td>
      `;
      tbody.appendChild(tr);
    });

  }catch(err){ console.error(err); tbody.innerHTML="<tr><td colspan='9' style='text-align:center;'>Error loading requests</td></tr>";}
}

async function cancelRequest(id){
  if(!confirm("Cancel this request?")) return;
  try{
    const res = await fetch(`${API_URL}/cancel/${id}`, { method:"DELETE", headers:{Authorization:"Bearer "+token} });
    const data = await res.json();
    if(res.ok){ alert(data.message||"Request cancelled!"); loadMyRequests(); }
    else alert(data.error||"Error cancelling request.");
  }catch(err){ console.error(err); alert("Network error cancelling request."); }
}

document.getElementById("carRequisitionForm").addEventListener("submit", async e=>{
  e.preventDefault();
  const formData={
    date: document.getElementById("date").value,
    department: document.getElementById("department").value,
    requestedBy: document.getElementById("requestedBy").value,
    purpose: document.getElementById("purpose").value,
    destination: document.getElementById("destination").value,
    departure: document.getElementById("departure").value,
    return: document.getElementById("return").value,
    passengers: document.getElementById("passengers").value,
    vehicleType: document.getElementById("vehicleType").value
  };
  try{
    const res = await fetch(`${API_URL}/submit`, { method:"POST", headers:{"Content-Type":"application/json", Authorization:"Bearer "+token}, body:JSON.stringify(formData) });
    const data = await res.json();
    if(res.ok){ alert(data.message||"Submitted!"); resetForm(); loadMyRequests(); }
    else alert(data.error||"Error submitting");
  }catch(err){ console.error(err); alert("Network error submitting.");}
});

function resetForm(){ document.getElementById("carRequisitionForm").reset(); document.getElementById("date").valueAsDate=new Date(); document.getElementById("requestedBy").value=username; }
function logout(){ localStorage.clear(); window.location.href="index.html"; }
loadMyRequests(); setInterval(loadMyRequests,15000);
</script>
<!-- Footer -->
<footer style="text-align:center; padding:15px 0; font-size:12px; color:#777;">
    ¬© 2025 Mugonero District Hospital | All rights reserved
</footer>

</body>
</html>
