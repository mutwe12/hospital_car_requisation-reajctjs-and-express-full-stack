<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>DAF Approval | Car Requisition</title>
<style>
  body { font-family:'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background-color:#f7f9fc; margin:0; padding:0; }
  .navbar { background-color:#004aad; color:white; padding:12px 30px; display:flex; justify-content:space-between; align-items:center; }
  .navbar h1 { margin:0; font-size:20px; }
  .navbar button { background:#dc3545; color:white; border:none; padding:6px 12px; border-radius:4px; cursor:pointer; }
  .navbar button:hover { background:#a71d2a; }

  .welcome-box { background:#e9f1ff; border-left:5px solid #004aad; max-width:1100px; margin:20px auto; padding:15px 25px; border-radius:6px; box-shadow:0 2px 6px rgba(0,0,0,0.05); color:#004aad; font-size:17px; display:flex; justify-content:space-between; align-items:center; }
  .welcome-box span { font-weight:bold; }

  .container { max-width:1100px; margin:20px auto; background:white; padding:20px 30px; border-radius:8px; box-shadow:0 3px 15px rgba(0,0,0,0.1); }
  h2 { text-align:center; color:#004aad; margin-bottom:25px; }

  table { width:100%; border-collapse:collapse; box-shadow:0 2px 8px rgba(0,0,0,0.05); }
  th, td { padding:12px 10px; text-align:center; border-bottom:1px solid #ddd; }
  th { background-color:#004aad; color:white; position: sticky; top:0; }
  tr:nth-child(even){ background:#f8f9fa; }

  button.approve-btn { background:#28a745; color:white; padding:6px 12px; border-radius:4px; border:none; cursor:pointer; }
  button.approve-btn:hover { background:#218838; }
  button.reject-btn { background:#dc3545; color:white; padding:6px 12px; border-radius:4px; border:none; cursor:pointer; }
  button.reject-btn:hover { background:#c82333; }
  button.details-btn { background:#007bff; color:white; padding:6px 12px; border-radius:4px; border:none; cursor:pointer; }

  .badge-approved { background:#28a745; color:white; padding:4px 8px; border-radius:4px; font-weight:bold; }
  .badge-pending { background:#f59e0b; color:white; padding:4px 8px; border-radius:4px; font-weight:bold; }
  .badge-rejected { background:#dc3545; color:white; padding:4px 8px; border-radius:4px; font-weight:bold; }

  .modal { display:none; position:fixed; z-index:100; left:0; top:0; width:100%; height:100%; background:rgba(0,0,0,0.6);}
  .modal-content { background:#fff; margin:10% auto; padding:20px; width:60%; border-radius:8px; box-shadow:0 0 10px rgba(0,0,0,0.3);}
  .modal-header { display:flex; justify-content:space-between; align-items:center; border-bottom:1px solid #ccc; padding-bottom:8px;}
  .close-btn { cursor:pointer; font-size:22px; color:#dc3545; font-weight:bold; }
  .modal-body p { margin:8px 0; font-size:16px; }

  @media(max-width:768px){
    table, thead, tbody, th, td, tr { display:block; }
    th { position:relative; top:auto; background:#004aad; color:white; }
    td { text-align:right; padding-left:50%; position:relative; }
    td::before { content:attr(data-label); position:absolute; left:10px; width:45%; text-align:left; font-weight:bold; }
  }
</style>
</head>
<body>

<nav class="navbar">
  <h1>üöó Car Requisition System - DAF</h1>
  <button onclick="logout()">Logout</button>
</nav>

<div class="welcome-box">
  <div>Welcome, <span id="dafName">DAF User</span> üëã</div>
  <div id="dateToday"></div>
</div>

<div class="container">
  <h2>Pending DAF Approvals</h2>
  <table>
    <thead>
      <tr>
        <th>ID</th>
        <th>Requester</th>
        <th>Department</th>
        <th>Destination</th>
        <th>Vehicle Type</th>
        <th>Status</th>
        <th>Action</th>
      </tr>
    </thead>
    <tbody id="pendingBody">
      <tr><td colspan="7">Loading...</td></tr>
    </tbody>
  </table>
</div>

<!-- Modal -->
<div id="detailsModal" class="modal">
  <div class="modal-content">
    <div class="modal-header">
      <h3>Requisition Details</h3>
      <span class="close-btn" onclick="closeModal()">&times;</span>
    </div>
    <div class="modal-body" id="modalBody"></div>
  </div>
</div>

<script>
const API_URL = "/api/requisition";
const token = localStorage.getItem("token");
const role = localStorage.getItem("role");
const dafName = localStorage.getItem("userName") || "DAF User";

if(role !== "daf" && role !== "admin"){ alert("Access denied"); window.location.href="index.html"; }
document.getElementById("dafName").textContent = dafName;
document.getElementById("dateToday").textContent = new Date().toLocaleDateString();

async function loadPending() {
  try {
    const res = await fetch(API_URL, { headers:{ "Authorization": `Bearer ${token}` } });
    const data = await res.json();
    const tbody = document.getElementById("pendingBody");
    tbody.innerHTML = "";

    const pending = data.filter(r => r.logisticsSignature==="Approved" && (!r.dafSignature || r.dafSignature==="Pending"));
    if(!pending.length){ tbody.innerHTML='<tr><td colspan="7">No pending requisitions</td></tr>'; return; }

    pending.forEach(req=>{
      let status = req.dafSignature==='Approved' ? "‚úÖ Approved" : req.dafSignature==='Rejected' ? "‚ùå Rejected" : "‚è≥ Pending";
      let badgeClass = req.dafSignature==='Approved' ? "badge-approved" : req.dafSignature==='Rejected' ? "badge-rejected" : "badge-pending";

      const row = document.createElement("tr");
      row.innerHTML = `
        <td data-label="ID">${req.id}</td>
        <td data-label="Requester">${req.requestedBy}</td>
        <td data-label="Department">${req.department}</td>
        <td data-label="Destination">${req.destination}</td>
        <td data-label="Vehicle">${req.vehicleType}</td>
        <td data-label="Status"><span class="${badgeClass}">${status}</span></td>
        <td data-label="Action">
          <button class="approve-btn" onclick="approve(${req.id})">Approve</button>
          <button class="reject-btn" onclick="reject(${req.id})">Reject</button>
          <button class="details-btn" onclick='viewDetails(${JSON.stringify(req)})'>Details</button>
        </td>
      `;
      tbody.appendChild(row);
    });
  } catch(err){ console.error(err); alert("Error loading requisitions"); }
}

async function approve(id){
  try{
    const res = await fetch(`${API_URL}/approve/daf/${id}`, {
      method:"PUT", headers:{ "Content-Type":"application/json", "Authorization": `Bearer ${token}` },
      body: JSON.stringify({ dafSignature:"Approved" })
    });
    const data = await res.json(); alert(data.message); loadPending();
  }catch(err){ console.error(err); alert("Error approving"); }
}

async function reject(id){
  const reason = prompt("Enter rejection reason:"); if(!reason) return;
  try{
    const res = await fetch(`${API_URL}/reject/daf/${id}`, {
      method:"PUT", headers:{ "Content-Type":"application/json", "Authorization": `Bearer ${token}` },
      body: JSON.stringify({ dafSignature:"Rejected", reason })
    });
    const data = await res.json(); alert(data.message); loadPending();
  }catch(err){ console.error(err); alert("Error rejecting"); }
}

function viewDetails(req){
  const modal=document.getElementById("detailsModal");
  document.getElementById("modalBody").innerHTML = Object.keys(req).map(k=>`<p><strong>${k}:</strong> ${req[k]||'-'}</p>`).join('');
  modal.style.display="block";
}
function closeModal(){ document.getElementById("detailsModal").style.display="none"; }
window.onclick=function(e){ if(e.target===document.getElementById("detailsModal")) closeModal(); }

function logout(){ localStorage.clear(); window.location.href="index.html"; }

loadPending();
</script>

</body>
</html>
